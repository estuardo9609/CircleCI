version: 2.1
jobs:
  # I will install node modules separetly to use a workspace
  install:
    working_directory: ~/app
    executor: node/default
    steps:
      - checkout
      # Install project packages to get node modules
      - node/install-packages:
          override-ci-command: npm install
          cache-path: node_modules
      - run:
          command: |
            echo "I have succesfully installed my node modules, trying to "
      # Since I have my node modules i will take them to workspace
      # https://circleci.com/docs/2.0/configuration-reference/#persist_to_workspace
      # https://discuss.circleci.com/t/error-locating-workspace-root-directory-stat/13709/3
      - persist_to_workspace:
          root: /root/app/project/node_modules
          paths:
            - .
  
  # I will run my tests now
  test:
    executor: node/default
    steps:
      - checkout
      - attach_workspace:
          at: .
      - node/install-npm
      - run:
          command: npm run test
  
orbs:
  # https://circleci.com/developer/orbs/orb/circleci/node
  node: circleci/node@4.1.0

workflows:
  version: 2
  test:
    jobs:
      - install
      - test:
          requires:
            - install
  